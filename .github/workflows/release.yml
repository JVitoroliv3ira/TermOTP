name: Build and Release

on:
  push:
    tags:
      - 'v*' 

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [linux, windows]
        arch: [amd64]

    steps:
      - name: Checkout c√≥digo-fonte
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24
          check-latest: true

      - name: Verificar vers√£o do Go e depend√™ncias
        run: |
          go version
          go env
          go mod tidy

      - name: Obter vers√£o do Git Tag
        id: get_version
        run: echo "VERSION=$(git describe --tags --always)" >> $GITHUB_ENV

      - name: Compilar Bin√°rio
        run: |
          BIN_NAME="totp-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then BIN_NAME="${BIN_NAME}.exe"; fi
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -ldflags "-X 'github.com/JVitoroliv3ira/termotp/internal/version.Version=${VERSION}'" -o $BIN_NAME

      - name: Criar Artefatos
        uses: actions/upload-artifact@v4
        with:
          name: totp-${{ matrix.os }}-${{ matrix.arch }}
          path: totp-${{ matrix.os }}-${{ matrix.arch }}*

  release:
    name: Criar Release no GitHub
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout c√≥digo-fonte
        uses: actions/checkout@v4

      - name: Obter Artefatos dos Builds
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Criar Release com Instru√ß√µes de Instala√ß√£o
        uses: softprops/action-gh-release@v2
        with:
          body: |
            # üöÄ TermOTP - Vers√£o ${{ github.ref_name }}

            **TermOTP** √© um gerador de c√≥digos TOTP no terminal, ideal para autentica√ß√£o 2FA.

            ## üì• Como Instalar
            
            ### üîπ **Linux**
            **‚ö†Ô∏è Importante:** Para instalar corretamente, os seguintes comandos devem ser executados no terminal:

            ```sh
            # Remover vers√£o antiga, se existir
            sudo rm -f /usr/local/bin/totp

            # Baixar a vers√£o mais recente do TermOTP
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/totp-linux-amd64 -O totp

            # Dar permiss√£o de execu√ß√£o ao bin√°rio
            chmod +x totp

            # Mover o execut√°vel para um local acess√≠vel globalmente (precisa de sudo)
            sudo mv totp /usr/local/bin/
            ```

            **Agora voc√™ pode executar `totp` de qualquer lugar no terminal!** üöÄ

            ### üîπ **Windows**
            **‚ö†Ô∏è Importante:** Para instalar, execute o PowerShell como **Administrador** antes de rodar os comandos abaixo!

            ```powershell
            # Remover vers√£o antiga, se existir
            Remove-Item "C:\Program Files\TermOTP\totp.exe" -ErrorAction SilentlyContinue

            # Criar pasta de instala√ß√£o (caso ainda n√£o exista)
            mkdir "C:\Program Files\TermOTP" -ErrorAction SilentlyContinue

            # Baixar a vers√£o mais recente do TermOTP
            Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/totp-windows-amd64.exe" -OutFile "C:\Program Files\TermOTP\totp.exe"

            # Adicionar TOTP ao PATH do sistema
            [System.Environment]::SetEnvironmentVariable("Path", $Env:Path + ";C:\Program Files\TermOTP", [System.EnvironmentVariableTarget]::Machine)
            ```

            **Agora reinicie o terminal e rode `totp` de qualquer lugar!** üöÄ

            ## üìñ Como Usar o TermOTP
            - **Adicionar uma conta**: `totp setup --name google`
            - **Listar c√≥digos TOTP**: `totp list`
            - **Copiar um c√≥digo para o clipboard**: `totp copy --name google`

            üîπ *Se curtiu, deixa uma ‚≠ê no reposit√≥rio!*
          files: artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
