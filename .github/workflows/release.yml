name: Build and Release

on:
  push:
    tags:
      - 'v*' 

jobs:
  build:
    name: Build Binaries
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [linux, windows]
        arch: [amd64]

    steps:
      - name: Checkout c√≥digo-fonte
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.24
          check-latest: true

      - name: Verificar vers√£o do Go e depend√™ncias
        run: |
          go version
          go env
          go mod tidy

      - name: Obter vers√£o do Git Tag
        id: get_version
        run: echo "VERSION=$(git describe --tags --always)" >> $GITHUB_ENV

      - name: Compilar Bin√°rio
        run: |
          BIN_NAME="termotp-${{ matrix.os }}-${{ matrix.arch }}"
          if [ "${{ matrix.os }}" = "windows" ]; then BIN_NAME="${BIN_NAME}.exe"; fi
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -ldflags "-X 'github.com/JVitoroliv3ira/termotp/internal/version.Version=${VERSION}'" -o $BIN_NAME

      - name: Criar Artefatos
        uses: actions/upload-artifact@v4
        with:
          name: termotp-${{ matrix.os }}-${{ matrix.arch }}
          path: termotp-${{ matrix.os }}-${{ matrix.arch }}*

  release:
    name: Criar Release no GitHub
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout c√≥digo-fonte
        uses: actions/checkout@v4

      - name: Obter Artefatos dos Builds
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Criar Release com Instru√ß√µes de Instala√ß√£o
        uses: softprops/action-gh-release@v2
        with:
          body: |
            # üöÄ TermOTP - Vers√£o ${{ github.ref_name }}

            TermOTP √© um gerador de c√≥digos TOTP no terminal, ideal para autentica√ß√£o 2FA.

            ## üì• Como Instalar
            
            ### üîπ **Linux**
            ```sh
            sudo rm -f /usr/local/bin/termotp
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/termotp-linux-amd64 -O termotp
            chmod +x termotp
            sudo mv termotp /usr/local/bin/
            ```

            ### üîπ **Windows**
            ```powershell
            Remove-Item "C:\Program Files\TermOTP\termotp.exe" -ErrorAction SilentlyContinue
            mkdir "C:\Program Files\TermOTP" -ErrorAction SilentlyContinue
            Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/termotp-windows-amd64.exe" -OutFile "C:\Program Files\TermOTP\termotp.exe"
            [System.Environment]::SetEnvironmentVariable("Path", $Env:Path + ";C:\Program Files\TermOTP", [System.EnvironmentVariableTarget]::Machine)
            ```

            **Agora reinicie o terminal e rode `termotp` de qualquer lugar!** üöÄ

            ## üìñ Como Usar
            - **Adicionar uma conta**: `termotp setup --name gitlab`
            - **Gerar um c√≥digo**: `termotp list`
            - **Copiar um c√≥digo para o clipboard**: `termotp copy --name gitlab`

            üîπ *Se curtiu, deixa uma ‚≠ê no reposit√≥rio!*
          files: artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
